<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>iOS 삭제 문제 해결</title>
  <style>
    input {
      padding: 8px;
      font-size: 16px;
    }
    .maxed {
      border: 2px solid red;
      background-color: #ffe6e6;
    }
    .hidden-input {
      position: absolute;
      width: 1px;
      height: 1px;
      left: -9999px;
    }
  </style>
</head>
<body>

  <input type="text" maxlength="5" class="watch-input" placeholder="입력하세요">

  <script>
    function handleInput(input) {
      const maxLen = parseInt(input.getAttribute('maxlength'), 10);
      const value = input.value;

      if (value.length >= maxLen) {
        input.classList.add('maxed');
      } else {
        input.classList.remove('maxed');
      }
    }

    // 삭제 시 iOS 대응 우회처리
    function setupIOSBackspaceFix(input) {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Backspace') {
          // iOS의 조합 상태일 수 있으므로, 우회적으로 리셋
          const hiddenInput = document.createElement('input');
          hiddenInput.className = 'hidden-input';
          document.body.appendChild(hiddenInput);

          // 0. iOS에서 조합 문제 해결을 위해 blur → focus 우회
          input.blur();

          setTimeout(() => {
            hiddenInput.focus();

            setTimeout(() => {
              hiddenInput.remove(); // 히든 인풋 제거
              input.focus(); // 원래 인풋으로 복귀
            }, 10);
          }, 10);
        }
      });
    }

    // 초기 바인딩
    document.querySelectorAll('.watch-input').forEach(input => {
      input.addEventListener('input', () => handleInput(input));
      setupIOSBackspaceFix(input);
    });

    // ✅ 동적으로 생성되는 인풋에도 적용
    const observer = new MutationObserver(() => {
      document.querySelectorAll('.watch-input').forEach(input => {
        if (!input._watchSetup) {
          input.addEventListener('input', () => handleInput(input));
          setupIOSBackspaceFix(input);
          input._watchSetup = true; // 중복 방지
        }
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  </script>
</body>
</html>