<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Scroll Tabs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      list-style: none;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }

    .tab-container {
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    .tabs {
      position: relative;
    }

    .tab-indicator {
      position: absolute;
      left: 0;
      bottom: 0;
      height: 2px;
      background: #3498db;
      transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
      width: 0;
      z-index: 2;
    }

    .tabs_group {
      position: relative;
      display: flex;
      border-bottom: 2px solid #ddd;
    }

    .tabs_item {
      flex: 1;
    }

    .tabs_btn {
      display: flex;
      justify-content: center;
      width: 100%;
      padding: 15px;
      text-align: center;
      background-color: #f9f9f9;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .tabs_btn:hover {
      background-color: #ddd;
    }

    .tabs_btn.active {
      font-weight:bold;
      background-color: #eee;
    }

    .tab-content {
      transition: opacity 0.3s ease-in-out;
    }

    .tab-pane {
      display: none;
      opacity: 0;
      padding: 20px;
    }

    .tab-pane.active {
      display: block;
      opacity: 1;
    }

    .tab-container[data-tab="scroll"] .tabs {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: white;
    }

    .tab-container[data-tab="scroll"] .tab-pane {
      height: 1000px;
    }

    .tab-container[data-tab="scroll"] .tab-pane:nth-child(odd) {
      background-color: aquamarine;
    }

    .tab-container[data-tab="scroll"] .tab-pane:nth-child(even) {
      background-color: beige;
    }
  </style>
</head>

<body>

  <!-- 일반 탭 -->
  <div class="tab-container">
    <div class="tabs" role="tablist">
      <ul class="tabs_group">
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_1_1" aria-controls="tab1_1" role="tab">Tab 1</button>
        </li>
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_1_2" aria-controls="tab1_2" role="tab">Tab 2</button>
        </li>
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_1_3" aria-controls="tab1_3" role="tab">Tab 3</button>
        </li>
      </ul>
      <div class="tab-indicator"></div>
    </div>
    <div class="tab-content">
      <div id="tab1_1" class="tab-pane" role="tabpanel">
        <h2>Tab 1 Content</h2>
        <p>This is the content for Tab 1.</p>
      </div>
      <div id="tab1_2" class="tab-pane" role="tabpanel">
        <h2>Tab 2 Content</h2>
        <p>This is the content for Tab 2.</p>
      </div>
      <div id="tab1_3" class="tab-pane" role="tabpanel">
        <h2>Tab 3 Content</h2>
        <p>This is the content for Tab 3.</p>
      </div>
    </div>
  </div>

  <br><br>

  <!-- 스크롤 연동 탭 -->
  <div class="tab-container" data-tab="scroll">
    <div class="tabs" role="tablist">
      <ul class="tabs_group">
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_2_1" aria-controls="tab2_1">Tab 1</button></li>
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_2_2" aria-controls="tab2_2">Tab 2</button></li>
        <li class="tabs_item"><button class="tabs_btn" id="tab_btn_2_3" aria-controls="tab2_3">Tab 3</button></li>
      </ul>
      <div class="tab-indicator"></div>
    </div>
    <div class="tab-content">
      <div id="tab2_1" class="tab-pane" role="tabpanel">
        <h2>Tab 1 Scroll Content</h2>
      </div>
      <div id="tab2_2" class="tab-pane" role="tabpanel">
        <h2>Tab 2 Scroll Content</h2>
      </div>
      <div id="tab2_3" class="tab-pane" role="tabpanel">
        <h2>Tab 3 Scroll Content</h2>
      </div>
    </div>
  </div>

  <script>
    const TabUI = {
      initAll() {
        const containers = document.querySelectorAll('.tab-container');
        containers.forEach(container => this.init(container));
      },

      init(container) {
        const isScrollTab = container.dataset.tab === 'scroll';
        const tabs = container.querySelectorAll('.tabs_btn');
        const tabPanes = container.querySelectorAll('.tab-pane');
        const indicator = container.querySelector('.tab-indicator');

        if (!tabs.length || !tabPanes.length) return;

        // 리스너 제거용 복제
        tabs.forEach(tab => {
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
        });

        const updatedTabs = container.querySelectorAll('.tabs_btn');

        if (isScrollTab) {
          const scrollState = {
            isScrollingByClick: false,
            scrollTargetIdx: null
          };

          // 항상 표시
          tabPanes.forEach(pane => {
            pane.classList.add('active');
            pane.removeAttribute('hidden');
          });

          updatedTabs.forEach((tab, idx) => {
            tab.addEventListener('click', () => {
              scrollState.isScrollingByClick = true;
              scrollState.scrollTargetIdx = idx;

              const pane = tabPanes[idx];
              const paneRect = pane.getBoundingClientRect();
              const scrollY = window.scrollY || window.pageYOffset;
              const tabsEl = container.querySelector('.tabs');
              const tabsHeight = tabsEl ? tabsEl.offsetHeight : 0;
              const targetY = paneRect.top + scrollY - tabsHeight;

              this.activateTab(updatedTabs, tabPanes, idx, indicator, true);

              window.scrollTo({
                top: targetY,
                behavior: 'smooth'
              });
            });

            // 키보드 이벤트 처리
            this.setupKeyboardNavigation(tab, idx, updatedTabs);
          });

          window.addEventListener('scroll', () => {
            this.handleScrollNavigation(updatedTabs, tabPanes, indicator, scrollState);
          });

          this.activateTab(updatedTabs, tabPanes, 0, indicator, true);
        } else {
          updatedTabs.forEach((tab, idx) => {
            tab.addEventListener('click', () => {
              this.activateTab(updatedTabs, tabPanes, idx, indicator);
            });

            // 키보드 이벤트 처리
            this.setupKeyboardNavigation(tab, idx, updatedTabs);
          });

          this.activateTab(updatedTabs, tabPanes, 0, indicator);
        }
      },

      setupKeyboardNavigation(tab, idx, updatedTabs) {
        tab.addEventListener('keydown', e => {
          let newIdx = idx;

          // 화살표 키로 이동
          if (e.key === 'ArrowRight') {
            newIdx = (idx + 1) % updatedTabs.length;
          } else if (e.key === 'ArrowLeft') {
            newIdx = (idx - 1 + updatedTabs.length) % updatedTabs.length;
          }

          // 이동 후 해당 탭에 포커스를 맞춘다.
          updatedTabs[newIdx].focus();

          // Enter 또는 Space로 탭 활성화
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault(); // 기본 동작(스크롤 등)을 막고
            updatedTabs[newIdx].click(); // 해당 탭을 클릭하여 활성화
          }
        });
      },

      handleScrollNavigation(tabs, panes, indicator, scrollState) {
        const { isScrollingByClick, scrollTargetIdx } = scrollState;

        const tabsEl = tabs[0].closest('.tab-container').querySelector('.tabs');
        const tabsHeight = tabsEl ? tabsEl.offsetHeight : 0;

        if (isScrollingByClick && scrollTargetIdx !== null) {
          const pane = panes[scrollTargetIdx];
          const paneTop = pane.getBoundingClientRect().top;

          if (Math.abs(paneTop - tabsHeight) <= 10) {
            scrollState.isScrollingByClick = false;
            scrollState.scrollTargetIdx = null;
            this.activateTab(tabs, panes, scrollTargetIdx, indicator, true);
          }
          return;
        }

        let foundIdx = 0;
        let minDiff = Infinity;
        const tabsBottom = tabsEl.getBoundingClientRect().bottom;

        panes.forEach((pane, idx) => {
          const rect = pane.getBoundingClientRect();
          const diff = Math.abs(rect.top - tabsBottom);
          if (rect.top - tabsBottom <= 10 && diff < minDiff) {
            minDiff = diff;
            foundIdx = idx;
          }
        });

        this.activateTab(tabs, panes, foundIdx, indicator, true);
      },

      activateTab(tabs, panes, idx, indicator, isScrollTab = false) {
        tabs.forEach((tab, i) => {
          tab.classList.toggle('active', i === idx);
          tab.setAttribute('aria-selected', i === idx ? 'true' : 'false');
          tab.setAttribute('tabindex', i === idx ? '0' : '-1');
        });

        
        panes.forEach((pane, i) => {
          if (!isScrollTab) {
            pane.classList.toggle('active', i === idx);
            pane.hidden = i !== idx;
          } else {
            pane.setAttribute('aria-hidden', i !== idx ? 'true' : 'false');
          }
        });
        

        if (indicator && tabs[idx]) {
          const tab = tabs[idx];
          indicator.style.width = `${tab.offsetWidth}px`;
          indicator.style.left = `${tab.offsetLeft}px`;
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      TabUI.initAll();
    });



  </script>
</body>

</html>
